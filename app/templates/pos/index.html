{% extends "base.html" %}

{% block title %}Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ - POS{% endblock %}

{% block extra_css %}
<style>
    /* ========== ØªØµÙ…ÙŠÙ… Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ ========== */

    :root {
        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --info-color: #3b82f6;
        --dark-bg: #1f2937;
        --light-bg: #f9fafb;
        --border-color: #e5e7eb;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    body {
        background-color: var(--light-bg);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
    }

    .pos-container {
        height: calc(100vh - 60px);
        max-height: calc(100vh - 60px);
        overflow: hidden;
        padding: 0;
        margin: 0;
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        bottom: 0;
    }

    /* ========== Ù‚Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ========== */
    .products-section {
        height: 100%;
        max-height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 15px;
        background: white;
        border-radius: 0;
    }

    .search-box {
        position: sticky;
        top: 0;
        z-index: 100;
        background: white;
        padding: 10px 0;
        margin-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
    }

    .search-box input {
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 12px 20px;
        font-size: 16px;
        transition: all 0.3s;
    }

    .search-box input:focus {
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .product-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid var(--border-color);
        border-radius: 16px;
        overflow: hidden;
        background: white;
        height: 100%;
        position: relative;
    }

    .product-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-xl);
    }

    .product-card:active {
        transform: translateY(-4px);
    }

    .product-image {
        height: 140px;
        object-fit: cover;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 48px;
        font-weight: bold;
    }

    .product-card .card-body {
        padding: 15px;
    }

    .product-card .card-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--dark-bg);
        margin-bottom: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .product-price {
        font-size: 20px;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 5px;
    }

    .product-stock {
        font-size: 13px;
        color: #6b7280;
    }

    .stock-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        box-shadow: var(--shadow-md);
    }

    /* ========== Ù‚Ø³Ù… Ø§Ù„Ø³Ù„Ø© ========== */
    .cart-section {
        height: 100%;
        max-height: 100%;
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 0;
        box-shadow: var(--shadow-xl);
        overflow: hidden;
    }

    .cart-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 15px;
        border-radius: 0;
        flex-shrink: 0;
    }

    .cart-header h4 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .session-info {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        padding: 12px;
        border-radius: 10px;
        margin-top: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .session-info-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
        font-size: 13px;
    }

    .session-info-item:last-child {
        margin-bottom: 0;
    }

    .cart-items {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 15px;
        background: #fafafa;
        max-height: calc(100vh - 500px);
    }

    .cart-item {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 12px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        transition: all 0.3s;
    }

    .cart-item:hover {
        box-shadow: var(--shadow-md);
    }

    .cart-item h6 {
        font-size: 16px;
        font-weight: 600;
        color: var(--dark-bg);
        margin-bottom: 8px;
    }

    .qty-control {
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--light-bg);
        padding: 5px;
        border-radius: 10px;
    }

    .qty-control button {
        width: 36px;
        height: 36px;
        padding: 0;
        border-radius: 8px;
        border: none;
        background: white;
        font-weight: 600;
        transition: all 0.2s;
        box-shadow: var(--shadow-sm);
    }

    .qty-control button:hover {
        color: white;
        transform: scale(1.1);
    }

    .qty-control input {
        width: 60px;
        text-align: center;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-weight: 600;
        font-size: 16px;
    }

    .cart-empty {
        text-align: center;
        padding: 60px 20px;
        color: #9ca3af;
    }

    .cart-empty i {
        font-size: 80px;
        margin-bottom: 20px;
        opacity: 0.3;
    }

    /* ========== Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù„Ø© ========== */
    .cart-summary {
        border-top: 2px solid var(--border-color);
        padding: 15px;
        background: white;
        flex-shrink: 0;
        max-height: 400px;
        overflow-y: auto;
    }

    .customer-section {
        margin-bottom: 12px;
    }

    .customer-section select {
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 8px;
        font-size: 13px;
    }

    .discount-section {
        margin-bottom: 12px;
    }

    .discount-section input {
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 8px;
        font-size: 13px;
    }

    .totals-section {
        background: var(--light-bg);
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 12px;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .total-row:last-child {
        margin-bottom: 0;
        padding-top: 8px;
        border-top: 2px solid var(--border-color);
        font-size: 18px;
        font-weight: 700;
    }

    /* ========== Ø§Ù„Ø£Ø²Ø±Ø§Ø± ========== */
    .action-buttons {
        display: grid;
        gap: 8px;
    }

    .btn-pos {
        padding: 12px 16px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 14px;
        border: none;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        box-shadow: var(--shadow-md);
    }

    .btn-pos:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-pos:active {
        transform: translateY(0);
    }

    .btn-pos i {
        font-size: 18px;
    }

    .btn-pay {
        background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
        color: white;
    }

    .btn-quotation {
        background: linear-gradient(135deg, var(--info-color) 0%, #2563eb 100%);
        color: white;
    }

    .btn-hold {
        background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
        color: white;
    }

    .btn-clear {
        background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
        color: white;
    }

    .btn-close-session {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
    }

    /* ========== ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ========== */
    @media (max-width: 768px) {
        .pos-container {
            height: auto;
        }

        .products-section {
            height: 50vh;
        }

        .cart-section {
            height: 50vh;
        }

        .product-card {
            margin-bottom: 15px;
        }
    }

    /* ========== Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØµØµ ========== */
    .products-section::-webkit-scrollbar,
    .cart-items::-webkit-scrollbar,
    .cart-summary::-webkit-scrollbar {
        width: 6px;
    }

    .products-section::-webkit-scrollbar-track,
    .cart-items::-webkit-scrollbar-track,
    .cart-summary::-webkit-scrollbar-track {
        background: var(--light-bg);
    }

    .products-section::-webkit-scrollbar-thumb,
    .cart-items::-webkit-scrollbar-thumb,
    .cart-summary::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 10px;
    }

    .products-section::-webkit-scrollbar-thumb:hover,
    .cart-items::-webkit-scrollbar-thumb:hover,
    .cart-summary::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
    }

    /* ========== Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„ ========== */
    .container-fluid.pos-container {
        padding: 0 !important;
        margin: 0 !important;
    }

    .row.g-0 {
        margin: 0 !important;
    }

    .col-lg-7, .col-lg-5 {
        padding: 0 !important;
    }
</style>

<!-- Dynamic POS Styles -->
{% include 'pos/pos_styles.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid pos-container p-0">
    <div class="row g-0 h-100">
        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
        <div class="col-lg-7 products-section">
            <!-- Ø§Ù„Ø¨Ø­Ø« -->
            <div class="search-box">
                <div class="input-group input-group-lg">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fas fa-search text-primary"></i>
                    </span>
                    <input type="text" class="form-control border-start-0" id="product-search"
                           placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ØŒ Ø§Ù„ÙƒÙˆØ¯)..."
                           autocomplete="off">
                    <button class="btn btn-outline-secondary" type="button" id="clear-search">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
            <div class="row g-3" id="products-grid">
                {% for product in products %}
                <div class="col-6 col-md-4 col-xl-3 product-item"
                     data-name="{{ product.name }}"
                     data-code="{{ product.code }}"
                     data-barcode="{{ product.barcode or '' }}"
                     data-product-id="{{ product.id }}"
                     data-product-name="{{ product.name|replace("'", "&#39;")|replace('"', '&quot;') }}"
                     data-product-price="{{ product.selling_price }}">
                    <div class="card product-card h-100" onclick="return addToCartFromElement(this.parentElement, event);">
                        <span class="stock-badge">
                            <i class="fas fa-box"></i> {{ product.get_stock() }}
                        </span>
                        <div class="product-image">
                            {% if product.image_url %}
                            <img src="{{ product.image_url }}" class="w-100 h-100" alt="{{ product.name }}" style="object-fit: cover;">
                            {% else %}
                            <i class="fas fa-cube"></i>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <h6 class="card-title">{{ product.name }}</h6>
                            <div class="product-price">{{ product.selling_price }} {{ currency_symbol }}</div>
                            <div class="product-stock">
                                <i class="fas fa-barcode"></i> {{ product.code }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø³Ù„Ø© -->
        <div class="col-lg-5 cart-section">
            <!-- Ø±Ø£Ø³ Ø§Ù„Ø³Ù„Ø© -->
            <div class="cart-header">
                <h4>
                    <i class="fas fa-shopping-cart"></i>
                    Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
                    <span class="badge bg-white text-primary ms-2" id="cart-count">0</span>
                </h4>

                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ±Ø¯ÙŠØ© -->
                <div class="session-info">
                    <div class="session-info-item">
                        <span><i class="fas fa-cash-register"></i> Ø§Ù„ÙˆØ±Ø¯ÙŠØ©:</span>
                        <strong>{{ session.session_number }}</strong>
                    </div>
                    <div class="session-info-item">
                        <span><i class="fas fa-user"></i> Ø§Ù„ÙƒØ§Ø´ÙŠØ±:</span>
                        <strong>{{ current_user.full_name or current_user.username }}</strong>
                    </div>
                    <div class="session-info-item">
                        <span><i class="fas fa-warehouse"></i> Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</span>
                        <strong>{{ session.warehouse.name }}</strong>
                    </div>
                    <div class="session-info-item">
                        <span><i class="fas fa-clock"></i> Ø§Ù„ÙˆÙ‚Øª:</span>
                        <strong id="session-time"></strong>
                    </div>
                </div>
            </div>

            <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ù„Ø© -->
            <div class="cart-items" id="cart-items">
                <div class="cart-empty">
                    <i class="fas fa-shopping-cart"></i>
                    <h5>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</h5>
                    <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§</p>
                </div>
            </div>

            <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù„Ø© -->
            <div class="cart-summary">
                <!-- Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
                <div class="customer-section">
                    <label class="form-label fw-bold">
                        <i class="fas fa-user"></i> Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    </label>
                    <select class="form-select" id="customer-select">
                        <option value="">Ø¹Ù…ÙŠÙ„ Ø¹Ø§Ø¯ÙŠ - Walk-in Customer</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer.name }} - {{ customer.phone }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª -->
                <div class="totals-section">
                    <div class="total-row">
                        <span><i class="fas fa-calculator"></i> Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</span>
                        <strong><span id="subtotal">0.00</span> {{ currency_symbol }}</strong>
                    </div>

                    <div class="total-row">
                        <span><i class="fas fa-percent"></i> Ø§Ù„Ø®ØµÙ…:</span>
                        <div class="d-flex align-items-center gap-2">
                            <input type="number" class="form-control form-control-sm" id="discount-percent"
                                   value="0" min="0" max="100" step="0.1" onchange="updateTotals()"
                                   style="width: 70px;">
                            <span>%</span>
                        </div>
                    </div>

                    <div class="total-row">
                        <span>Ù…Ø¨Ù„Øº Ø§Ù„Ø®ØµÙ…:</span>
                        <strong class="text-danger">-<span id="discount-amount">0.00</span> {{ currency_symbol }}</strong>
                    </div>

                    <div class="total-row">
                        <span><i class="fas fa-receipt"></i> Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ({{ company.tax_rate if company and company.tax_rate else 15 }}%):</span>
                        <strong><span id="tax-amount">0.00</span> {{ currency_symbol }}</strong>
                    </div>

                    <div class="total-row">
                        <span><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                        <strong><span id="total">0.00</span> {{ currency_symbol }}</strong>
                    </div>
                </div>

                <!-- Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ -->
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-credit-card"></i> Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
                    </label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="payment-method" id="payment-cash" value="cash" checked>
                        <label class="btn btn-outline-success" for="payment-cash">
                            <i class="fas fa-money-bill-wave"></i> Ù†Ù‚Ø¯ÙŠ
                        </label>

                        <input type="radio" class="btn-check" name="payment-method" id="payment-card" value="card">
                        <label class="btn btn-outline-primary" for="payment-card">
                            <i class="fas fa-credit-card"></i> Ø¨Ø·Ø§Ù‚Ø©
                        </label>

                        <input type="radio" class="btn-check" name="payment-method" id="payment-mixed" value="mixed">
                        <label class="btn btn-outline-info" for="payment-mixed">
                            <i class="fas fa-exchange-alt"></i> Ù…Ø®ØªÙ„Ø·
                        </label>
                    </div>
                </div>

                <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø®ØªÙ„Ø· -->
                <div id="mixed-payment-details" style="display: none;">
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small">Ù†Ù‚Ø¯ÙŠ:</label>
                            <input type="number" class="form-control" id="cash-amount"
                                   value="0" min="0" step="0.01">
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Ø¨Ø·Ø§Ù‚Ø©:</label>
                            <input type="number" class="form-control" id="card-amount"
                                   value="0" min="0" step="0.01">
                        </div>
                    </div>
                </div>

                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
                <div class="action-buttons">
                    <button class="btn-pos btn-pay" onclick="processPayment()" id="pay-button" disabled>
                        <i class="fas fa-check-circle"></i>
                        <span>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹</span>
                    </button>

                    <button class="btn-pos btn-quotation" onclick="createQuotation()" id="quotation-button" disabled>
                        <i class="fas fa-file-invoice"></i>
                        <span>Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø³Ø¹Ø±</span>
                    </button>

                    <button class="btn-pos btn-hold" onclick="holdOrder()">
                        <i class="fas fa-pause-circle"></i>
                        <span>ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø·Ù„Ø¨</span>
                    </button>

                    <button class="btn-pos btn-clear" onclick="clearCart()">
                        <i class="fas fa-trash-alt"></i>
                        <span>Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø©</span>
                    </button>

                    <button class="btn-pos btn-close-session" onclick="closeSession()">
                        <i class="fas fa-power-off"></i>
                        <span>Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Version: 2026-01-15-v5 - Fixed totals undefined error
console.log('ğŸš€ POS Script loaded - Version 2026-01-15-v5');

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
let cart = [];
const TAX_RATE = {{ (company.tax_rate / 100) if company and company.tax_rate else 0.15 }};
const SESSION_ID = {{ session.id }};
const CURRENCY_SYMBOL = '{{ currency_symbol }}';

// Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø© Ù…Ù† Ø§Ù„Ø¹Ù†ØµØ±
window.addToCartFromElement = function(element, event) {
    console.log('âœ… addToCartFromElement called!', element);

    // Ù…Ù†Ø¹ Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„Ø­Ø¯Ø«
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }

    try {
        console.log('ğŸ“¦ Dataset:', element.dataset);
        const productId = parseInt(element.dataset.productId);
        const productName = element.dataset.productName;
        const price = parseFloat(element.dataset.productPrice);

        console.log('ğŸ“Š Product data:', {productId, productName, price});

        if (!productId || !productName || isNaN(price)) {
            console.error('âŒ Invalid data:', {productId, productName, price});
            throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
        }

        addToCart(productId, productName, price);
        console.log('âœ… Product added to cart successfully!');

        // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ù†Ø¬Ø§Ø­
        const card = element.querySelector('.product-card');
        if (card) {
            card.style.transform = 'scale(0.95)';
            setTimeout(() => {
                card.style.transform = '';
            }, 200);
        }

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø©: ' + error.message);
    }

    return false; // Ù…Ù†Ø¹ Ø£ÙŠ Ø¥Ø¬Ø±Ø§Ø¡ Ø§ÙØªØ±Ø§Ø¶ÙŠ
};

// Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø©
function addToCart(productId, productName, price) {
    const existingItem = cart.find(item => item.productId === productId);

    if (existingItem) {
        existingItem.quantity++;
    } else {
        cart.push({
            productId: productId,
            productName: productName,
            price: price,
            quantity: 1
        });
    }

    renderCart();
    updateTotals();
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©
function renderCart() {
    const cartItemsDiv = document.getElementById('cart-items');
    const cartCount = document.getElementById('cart-count');

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartCount.textContent = totalItems;

    if (cart.length === 0) {
        cartItemsDiv.innerHTML = `
            <div class="cart-empty">
                <i class="fas fa-shopping-cart"></i>
                <h5>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</h5>
                <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§</p>
            </div>
        `;
        document.getElementById('pay-button').disabled = true;
        document.getElementById('quotation-button').disabled = true;
        return;
    }

    document.getElementById('pay-button').disabled = false;
    document.getElementById('quotation-button').disabled = false;

    let html = '';
    cart.forEach((item, index) => {
        const itemTotal = item.price * item.quantity;
        html += `
            <div class="cart-item">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="flex-grow-1">
                        <h6>${item.productName}</h6>
                        <div class="text-muted small">
                            <i class="fas fa-tag"></i> ${item.price.toFixed(2)} ${CURRENCY_SYMBOL}
                        </div>
                    </div>
                    <button class="btn btn-sm btn-danger rounded-circle" onclick="removeFromCart(${index})"
                            style="width: 32px; height: 32px; padding: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="qty-control">
                        <button onclick="decreaseQty(${index})">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" value="${item.quantity}"
                               min="1" onchange="updateQty(${index}, this.value)">
                        <button onclick="increaseQty(${index})">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold" style="font-size: 18px; color: var(--primary-color);">
                            ${itemTotal.toFixed(2)} ${CURRENCY_SYMBOL}
                        </div>
                        <div class="text-muted small">
                            ${item.quantity} Ã— ${item.price.toFixed(2)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    cartItemsDiv.innerHTML = html;
}

// Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ù„Ø©
function removeFromCart(index) {
    cart.splice(index, 1);
    renderCart();
    updateTotals();
}

// Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©
function increaseQty(index) {
    cart[index].quantity++;
    renderCart();
    updateTotals();
}

// ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©
function decreaseQty(index) {
    if (cart[index].quantity > 1) {
        cart[index].quantity--;
        renderCart();
        updateTotals();
    }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©
function updateQty(index, newQty) {
    const qty = parseInt(newQty);
    if (qty > 0) {
        cart[index].quantity = qty;
        renderCart();
        updateTotals();
    }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
function updateTotals() {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const discountPercent = parseFloat(document.getElementById('discount-percent').value) || 0;
    const discountAmount = subtotal * (discountPercent / 100);
    const afterDiscount = subtotal - discountAmount;
    const taxAmount = afterDiscount * TAX_RATE;
    const total = afterDiscount + taxAmount;

    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('discount-amount').textContent = discountAmount.toFixed(2);
    document.getElementById('tax-amount').textContent = taxAmount.toFixed(2);
    document.getElementById('total').textContent = total.toFixed(2);

    // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø®Ø±Ù‰
    return {
        subtotal: subtotal,
        discount: discountAmount,
        tax: taxAmount,
        total: total
    };
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
function getTotals() {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const discountPercent = parseFloat(document.getElementById('discount-percent').value) || 0;
    const discountAmount = subtotal * (discountPercent / 100);
    const afterDiscount = subtotal - discountAmount;
    const taxAmount = afterDiscount * TAX_RATE;
    const total = afterDiscount + taxAmount;

    return {
        subtotal: subtotal,
        discount: discountAmount,
        tax: taxAmount,
        total: total
    };
}

// Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø©
function clearCart() {
    if (cart.length === 0) return;

    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø©ØŸ')) {
        cart = [];
        renderCart();
        updateTotals();
        document.getElementById('customer-select').value = '';
        document.getElementById('discount-percent').value = 0;
    }
}

// Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹
async function processPayment() {
    if (cart.length === 0) {
        alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!');
        return;
    }

    const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
    const customerId = document.getElementById('customer-select').value || null;
    const discountPercent = parseFloat(document.getElementById('discount-percent').value) || 0;

    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const discountAmount = subtotal * (discountPercent / 100);
    const afterDiscount = subtotal - discountAmount;
    const taxAmount = afterDiscount * TAX_RATE;
    const total = afterDiscount + taxAmount;

    let cashAmount = 0;
    let cardAmount = 0;

    if (paymentMethod === 'cash') {
        cashAmount = total;
    } else if (paymentMethod === 'card') {
        cardAmount = total;
    } else {
        cashAmount = parseFloat(document.getElementById('cash-amount').value) || 0;
        cardAmount = parseFloat(document.getElementById('card-amount').value) || 0;

        if (cashAmount + cardAmount < total) {
            alert('Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ!');
            return;
        }
    }

    const orderData = {
        session_id: SESSION_ID,
        customer_id: customerId,
        items: cart,
        subtotal: subtotal,
        discount_amount: discountAmount,
        tax_amount: taxAmount,
        total_amount: total,
        payment_method: paymentMethod,
        cash_amount: cashAmount,
        card_amount: cardAmount
    };

    try {
        const response = await fetch('/pos/create-order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData)
        });

        const result = await response.json();

        if (result.success) {
            alert('ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!\nØ±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ' + result.order_number);
            clearCart();

            // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ')) {
                window.open('/pos/print-receipt/' + result.order_id, '_blank');
            }
        } else {
            alert('Ø®Ø·Ø£: ' + result.message);
        }
    } catch (error) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
        console.error(error);
    }
}

// ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø·Ù„Ø¨
function holdOrder() {
    if (cart.length === 0) {
        alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!');
        return;
    }

    const orderName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚:');
    if (orderName) {
        const heldOrders = JSON.parse(localStorage.getItem('heldOrders') || '[]');
        heldOrders.push({
            name: orderName,
            cart: cart,
            customer: document.getElementById('customer-select').value,
            discount: document.getElementById('discount-percent').value,
            timestamp: new Date().toISOString()
        });
        localStorage.setItem('heldOrders', JSON.stringify(heldOrders));
        alert('ØªÙ… ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
        clearCart();
    }
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø³Ø¹Ø±
async function createQuotation() {
    console.log('ğŸ§¾ createQuotation called');
    if (cart.length === 0) {
        alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!');
        return;
    }

    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø³Ø¹Ø± Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„Ø©ØŸ')) {
        return;
    }

    try {
        const customerId = document.getElementById('customer-select').value;
        const discountPercent = parseFloat(document.getElementById('discount-percent').value) || 0;

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
        const totals = getTotals();

        console.log('ğŸ“¤ Sending quotation data:', {
            session_id: SESSION_ID,
            customer_id: customerId || null,
            items: cart,
            subtotal: totals.subtotal,
            discount_amount: totals.discount,
            tax_amount: totals.tax,
            total_amount: totals.total
        });

        const response = await fetch('/pos/create-quotation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: SESSION_ID,
                customer_id: customerId || null,
                items: cart,
                subtotal: totals.subtotal,
                discount_amount: totals.discount,
                tax_amount: totals.tax,
                total_amount: totals.total
            })
        });

        console.log('ğŸ“¥ Response status:', response.status);
        const result = await response.json();
        console.log('ğŸ“¥ Response data:', result);

        if (result.success) {
            alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø¨Ù†Ø¬Ø§Ø­!\nØ±Ù‚Ù… Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±: ' + result.quotation_number);

            // Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±ØŸ')) {
                console.log('ğŸ–¨ï¸ Opening print window for quotation:', result.quotation_id);
                window.open('/pos/print-quotation/' + result.quotation_id, '_blank');
            }

            clearCart();
        } else {
            console.error('âŒ Error from server:', result.message);
            alert('Ø®Ø·Ø£: ' + result.message);
        }
    } catch (error) {
        console.error('âŒ Error creating quotation:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±: ' + error.message);
    }
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙˆØ±Ø¯ÙŠØ©
function closeSession() {
    if (cart.length > 0) {
        alert('ÙŠØ¬Ø¨ Ø¥ØªÙ…Ø§Ù… Ø£Ùˆ Ù…Ø³Ø­ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙˆØ±Ø¯ÙŠØ©');
        return;
    }

    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙˆØ±Ø¯ÙŠØ©ØŸ')) {
        const closingBalance = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø®ØªØ§Ù…ÙŠ (Ø§Ù„Ù†Ù‚Ø¯ÙŠ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¬):');
        if (closingBalance !== null) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/pos/close-session/' + SESSION_ID;

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'closing_balance';
            input.value = closingBalance;

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    }
}

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
document.getElementById('product-search').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const productItems = document.querySelectorAll('.product-item');

    productItems.forEach(item => {
        const name = item.dataset.name.toLowerCase();
        const code = item.dataset.code.toLowerCase();
        const barcode = item.dataset.barcode.toLowerCase();

        if (name.includes(searchTerm) || code.includes(searchTerm) || barcode.includes(searchTerm)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
});

// Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«
document.getElementById('clear-search').addEventListener('click', function() {
    document.getElementById('product-search').value = '';
    document.querySelectorAll('.product-item').forEach(item => {
        item.style.display = '';
    });
});

// Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø®ØªÙ„Ø·
document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const mixedDetails = document.getElementById('mixed-payment-details');
        if (this.value === 'mixed') {
            mixedDetails.style.display = 'block';
        } else {
            mixedDetails.style.display = 'none';
        }
    });
});

// Ø¹Ø±Ø¶ ÙˆÙ‚Øª Ø§Ù„ÙˆØ±Ø¯ÙŠØ©
function updateSessionTime() {
    const now = new Date();
    const options = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
    document.getElementById('session-time').textContent = now.toLocaleTimeString('ar-SA', options);
}

updateSessionTime();
setInterval(updateSessionTime, 1000);

// Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
document.addEventListener('keydown', function(e) {
    // F1 - Ø§Ù„Ø¨Ø­Ø«
    if (e.key === 'F1') {
        e.preventDefault();
        document.getElementById('product-search').focus();
    }
    // F2 - Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹
    if (e.key === 'F2') {
        e.preventDefault();
        if (!document.getElementById('pay-button').disabled) {
            processPayment();
        }
    }
    // F3 - Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø©
    if (e.key === 'F3') {
        e.preventDefault();
        clearCart();
    }
    // ESC - Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«
    if (e.key === 'Escape') {
        document.getElementById('product-search').value = '';
        document.getElementById('clear-search').click();
    }
});
</script>
{% endblock %}

