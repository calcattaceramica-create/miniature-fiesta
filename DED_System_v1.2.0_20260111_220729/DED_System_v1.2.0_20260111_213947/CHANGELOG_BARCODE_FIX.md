# إصلاح مشكلة الحقول المكررة في المنتجات

## المشكلة
كانت الحقول `code`, `barcode`, `sku` في جدول `products` تحتوي على قيود فريدة (UNIQUE constraints)، مما يسبب:
1. منع إضافة أكثر من منتج بباركود فارغ
2. رسائل خطأ غير واضحة عند محاولة إدخال قيم مكررة
3. عدم التحقق المسبق قبل الإدخال في قاعدة البيانات

## الحل

### 1. تعديل النموذج (Model)
تم إزالة قيد `unique=True` من حقل `barcode` و `sku` في ملف `app/models_inventory.py`:

```python
# قبل التعديل
barcode = db.Column(db.String(128), unique=True, index=True)
sku = db.Column(db.String(64), unique=True)

# بعد التعديل
barcode = db.Column(db.String(128), index=True)  # Removed unique constraint
sku = db.Column(db.String(64))  # Removed unique constraint
```

### 2. تحديث دوال الإضافة والتعديل
تم تحديث دوال `add_product()` و `edit_product()` في ملف `app/inventory/routes.py` لتشمل:

#### التحقق من كود المنتج (Code) قبل الإضافة/التعديل
- التحقق من عدم وجود منتج آخر بنفس الكود
- عرض رسالة خطأ واضحة مع اسم المنتج المكرر
- منع الإدخال قبل الوصول لقاعدة البيانات

#### التحقق من الباركود (Barcode) قبل الإضافة/التعديل
- إذا كان الباركود فارغاً، يتم تعيينه إلى `None`
- إذا كان الباركود موجوداً، يتم التحقق من عدم وجوده لمنتج آخر
- عرض رسالة خطأ واضحة إذا كان الباركود مكرراً

#### التحقق من SKU قبل الإضافة/التعديل
- نفس المنطق المطبق على الباركود

### 3. Migration قاعدة البيانات
تم إنشاء وتطبيق migration لإزالة قيد الفريد من الفهرس:

```bash
python -m flask db migrate -m "Remove unique constraint from barcode and sku fields"
python -m flask db upgrade
```

### 4. تنظيف البيانات الموجودة
تم تحويل جميع القيم الفارغة (`''`) إلى `None` لتجنب التكرار.

## الميزات الجديدة

### 1. التحقق الذكي من جميع الحقول الفريدة
- **كود المنتج (Code)**: التحقق من عدم التكرار (إلزامي وفريد)
- **الباركود (Barcode)**: يسمح بترك الباركود فارغاً لعدة منتجات، ويمنع التكرار إذا كان له قيمة
- **SKU**: نفس منطق الباركود
- رسائل خطأ واضحة بالعربية تعرض اسم المنتج المكرر

### 2. معالجة الأخطاء
- استخدام `try-except` لمعالجة أي أخطاء غير متوقعة
- `rollback` تلقائي عند حدوث خطأ
- عرض رسالة الخطأ للمستخدم

## مثال على الاستخدام

### إضافة منتج بدون باركود
```python
product = Product(
    name='منتج جديد',
    code='PROD-001',
    barcode=None,  # أو تركه فارغاً
    # ... باقي الحقول
)
```

### إضافة منتج بباركود
```python
product = Product(
    name='منتج آخر',
    code='PROD-002',
    barcode='1234567890123',  # يجب أن يكون فريداً
    # ... باقي الحقول
)
```

## الملفات المعدلة

1. `app/models_inventory.py` - إزالة قيد الفريد من barcode و sku
2. `app/inventory/routes.py` - إضافة التحقق من الباركود والـ SKU
3. `migrations/versions/7da640fe5dae_*.py` - Migration لتحديث قاعدة البيانات

## ملاحظات مهمة

- **كود المنتج (Code)**: إلزامي وفريد - لا يمكن تكراره
- **الباركود (Barcode)**: اختياري - يمكن تركه فارغاً لعدة منتجات، ولكن إذا تم إدخاله يجب أن يكون فريداً
- **SKU**: اختياري - نفس منطق الباركود
- القيم الفارغة يتم تحويلها تلقائياً إلى `None`
- الفهرس (index) لا يزال موجوداً لتسريع البحث
- رسائل الخطأ تعرض اسم المنتج الذي يحتوي على القيمة المكررة

## التاريخ
- **2026-01-11**: تم إصلاح المشكلة وتطبيق التحديثات

